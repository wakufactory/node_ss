<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<script src="js/api.js"></script>
<script>
function $$(q){	return document.querySelectorAll(q);}
function $I(q){	return document.getElementById(q);}
function NFC(name) { if(name.normalize) name =  name.normalize('NFC') ; return name ;}

onload = function() {
	API.get({"cmd":"list"}).then(function(data) {
		console.log(data) ;
	}).catch(function(err) {
		console.log(err) ;
	})

	var upfile = null ;
	$I('send').addEventListener('click',function(e) {
		if(!upfile) return ;

		var data = API.formJSON( $I("f") ) ;
		console.log(data) ;
//return ;
		var p = API.post({"cmd":"saveinfo"},JSON.stringify(data));
		var u = API.upload({'fname':data.fname},upfile,function(ev){
			//progress callback
			console.log((ev.loaded/ev.total)*100) ;
		})
		Promise.all([p,u]).then(function(m) {
			console.log(m) ;
			console.log("all complete") ;
		}) ;
	})
	
	function previmg(f) {
		console.log(f) ;
		if(!f.type.match(/^image/)) return false ;
		upfile = f ;
		$I('imgpv').setAttribute("src","");
		$$('input[name=fname]')[0].value = NFC(f.name) ;
		var reader = new FileReader() ;
		reader.onload = function(e) {
			$I('imgpv').setAttribute("src", e.target.result) ;
		}
		reader.readAsDataURL(f) ;
		return true ;		
	}
	$I('f_sel').addEventListener("change",function(e){
		previmg(e.target.files[0]) ;
	})
	
	$I('droparea').addEventListener('dragover',function(e){
		e.preventDefault();
		this.setAttribute("data-over",1) ;
	});
	$I('droparea').addEventListener('dragleave',function(e){
		e.preventDefault();
		this.setAttribute("data-over",0) ;
	});
	$I('droparea').addEventListener('drop',function(e){
		e.preventDefault();
		this.setAttribute("data-over",0) ;
		var files = e.dataTransfer.files ;
		if(!files.length) return false ;
		previmg(files[0]) ;
	});
}
</script>
<link rel=stylesheet href="css/uploader.css"/>
<style>
#droparea {
	position:relative ;
	width:10rem ;
	height:10rem;
	border:2px solid black ;
	text-align:center ;
	line-height:10rem ;
}
#droparea[data-over="1"] {
	border:2px solid red ;
}
#imgpv {
	position:absolute ;
	left:0 ;
	max-width:10rem ;
	max-height:10rem ;

}
button {
	font-size:1.5rem ;
}
input,select,textarea {
	font-size:1rem ;
}
</style>
<body>
<h1>Image Uploader</h1>
<div id=droparea><img src="" id=imgpv />drop image here</div>
<br/>
<input type=file id=f_sel /><br/>
<form id=f>
filename:<input type="text" name=fname><br/>
title:<input type="text" name=title><br/>
check:<input type=checkbox value="hoge" name=c1>あ <input type=checkbox value="hage" name=c1>い <br/>
radio:<input type=radio name=r1 value="A">A <input type=radio name=r1 value="B">B<br/>
select:<select name=s1><option value=1>1</option><option>2</option><option>3</option></select><br>
description:<br/>
<textarea name=desc></textarea><br/>
</form>
<button id=send>send</button>
</body>
</html>