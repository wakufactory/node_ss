<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width"/>
<title>simple node server demo</title>
<script src="js/api.js"></script>
<script>
function $$(q){	return document.querySelectorAll(q);}
function $I(q){	return document.getElementById(q);}
function NFC(name) { if(name.normalize) name =  name.normalize('NFC') ; return name ;}

onload = function() {
	//get image list
	API.get({"cmd":"list"}).then(function(data) {
		console.log(data) ;
	}).catch(function(err) {
		console.log(err) ;
	})

	var upfile = null ;
	$I('send').addEventListener('click',function(e) {
		if(!upfile) return ;

		//get JSON data from forms
		var data = API.formJSON( $I("f") ) ;
		console.log(data) ;

		//post and upload api call
		var p = API.post({"cmd":"saveinfo"},JSON.stringify(data));
		var u = API.upload({'fname':data.fname},upfile,function(ev){
			//progress callback
			console.log((ev.loaded/ev.total)*100) ;
			$$('#progbar div')[0].style["width"] = (ev.loaded/ev.total*100)+"%" ;
		})
		Promise.all([p,u]).then(function(m) {
			console.log(m) ;
			console.log("all complete") ;
		}) ;
	})
	
	//image preview
	function previmg(f) {
		console.log(f) ;
		if(!f.type.match(/^image/)) return false ;
		upfile = f ;
		$I('imgpv').setAttribute("src","");
		$$('input[name=fname]')[0].value = NFC(f.name) ;
		$$('#progbar div')[0].style["width"] = "0%" ; 
		var reader = new FileReader() ;
		reader.onload = function(e) {
			$I('imgpv').setAttribute("src", e.target.result) ;
		}
		reader.readAsDataURL(f) ;
		return true ;		
	}
	$I('f_sel').addEventListener("change",function(e){
		previmg(e.target.files[0]) ;
	})
	$I('droparea').addEventListener('dragover',function(e){
		e.preventDefault();
		this.setAttribute("data-over",1) ;
	});
	$I('droparea').addEventListener('dragleave',function(e){
		e.preventDefault();
		this.setAttribute("data-over",0) ;
	});
	$I('droparea').addEventListener('drop',function(e){
		e.preventDefault();
		this.setAttribute("data-over",0) ;
		var files = e.dataTransfer.files ;
		if(!files.length) return false ;
		previmg(files[0]) ;
	});
}
</script>
<link rel=stylesheet href="css/uploader.css"/>
<body>
<h1>Image Uploader</h1>
<div id=droparea><img src="" id=imgpv />drop image here</div>
<input type=file id=f_sel /><br/>
<form id=f>
<dt>filename:</dt><dd><input type="text" name=fname></dd>
<dt>title:</dt><dd><input type="text" name=title></dd>
<dt>check:</dt>
<dd><input type=checkbox value="hoge" name=c1>hoge <input type=checkbox value="hage" name=c1>hage </dd>
<dt>radio:</dt><dd><input type=radio name=r1 value="A">A <input type=radio name=r1 value="B">B</dd>
<dt>select:</dt>
<dd><select name=s1><option value=1>select1</option><option value=2>select2</option><option value=3>select3</option></select></dd>
description:<br/>
<textarea name=desc></textarea><br/>
</form>
<button id=send>SEND</button><div id=progbar><div></div></div>
</body>
</html>